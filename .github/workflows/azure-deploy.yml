name: CI/CD Azure Deployment

on:
  push:
    branches:
      - main
    paths:
      - "src/container-app/**"
      - "src/function-app/**"
      - "src/frontend/**"

env:
  DOCKER_DRIVER: overlay2
  DOCKERFILE_PATH: ./Dockerfiles/Dockerfile.aca
  DOCKERFILE_PATH_FRONTEND: ./Dockerfiles/Dockerfile.frontend
  IMAGE_NAME: liotrag-aca
  IMAGE_NAME_FRONTEND: liotrag-frontend-aca
  IMAGE_VERSION: "0.2.0"
  AZURE_FUNCTION_ZIP_NAME: functionapp.zip

jobs:
  # -----------------------------
  # Build & Push Container Image
  # -----------------------------
  build-and-push:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[skip ci]') == false
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-dev gcc musl-dev libffi-dev make curl
          pip3 install --upgrade pip azure-cli docker

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME:${GITHUB_REF_NAME}-${GITHUB_SHA::7}"
          docker build --no-cache -f "$DOCKERFILE_PATH" -t "$IMAGE_TAG" .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Docker login to ACR
        run: |
          echo "${{ secrets.AZURE_CLIENT_SECRET }}" | docker login "${{ secrets.AZURE_ACR_LOGIN_SERVER }}" \
            -u "${{ secrets.AZURE_CLIENT_ID }}" --password-stdin

      - name: Push Docker image
        run: |
          docker push "$IMAGE_TAG"
          docker tag "$IMAGE_TAG" "${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME:dev-latest"
          docker push "${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME:dev-latest"

      - name: Save IMAGE_TAG for deploy jobs
        run: echo "$IMAGE_TAG" > image_tag.txt

      - uses: actions/upload-artifact@v4
        with:
          name: image_tag
          path: image_tag.txt

  # -----------------------------
  # Deploy Container App
  # -----------------------------
  deploy-container-app:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: image_tag

      - name: Load IMAGE_TAG
        run: echo "IMAGE_TAG=$(cat image_tag.txt)" >> $GITHUB_ENV

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip curl
          pip3 install --upgrade pip azure-cli

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy Container App
        run: |
          set -e
          CONTAINER_APP="${{ secrets.AZURE_CONTAINER_APP }}"
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          CONTAINERAPPS_ENV="${{ secrets.AZURE_CONTAINERAPPS_ENV }}"
          IMAGE="$IMAGE_TAG"

          APP_EXISTS=$(az containerapp show \
            --name "$CONTAINER_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "name" -o tsv || echo "")

          if [ -n "$APP_EXISTS" ]; then
            echo "Updating existing Container App with new image..."
            az containerapp update \
              --name "$CONTAINER_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$IMAGE" \
              --set-env-vars \
                KEY_VAULT_URL="${{ secrets.KEY_VAULT_URL }}" \
                AZURE_REDIS_CACHE_SECRET_NAME="${{ secrets.AZURE_REDIS_CACHE_SECRET_NAME }}" \
                AZURE_OPENAI_SECRET_NAME="${{ secrets.AZURE_OPENAI_SECRET_NAME }}" \
                AZURE_AI_SEARCH_SECRET_NAME="${{ secrets.AZURE_AI_SEARCH_SECRET_NAME }}" \
                AZURE_AI_SEARCH_URL="${{ secrets.AZURE_AI_SEARCH_URL }}" \
                AZURE_AI_SEARCH_INDEX_NAME="${{ secrets.AZURE_AI_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                REDIS_TTL_SECONDS="${{ secrets.REDIS_TTL_SECONDS }}" \
                MAX_HISTORY_TURNS="${{ secrets.MAX_HISTORY_TURNS }}" \
                AZURE_ENTRAID_CLIENT_ID="${{ secrets.AZURE_ENTRAID_CLIENT_ID }}" \
                AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
                AZURE_CLIENT_SECRET_NAME="${{ secrets.AZURE_CLIENT_SECRET_NAME }}"

          else
            echo "Container App does not exist, creating..."
            az containerapp create \
              --name "$CONTAINER_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINERAPPS_ENV" \
              --image "$IMAGE" \
              --ingress external \
              --target-port 80 \
              --cpu 2.0 \
              --memory 2.0Gi \
              --revision-mode Single \
              --set-env-vars \
                KEY_VAULT_URL="${{ secrets.KEY_VAULT_URL }}" \
                AZURE_REDIS_CACHE_SECRET_NAME="${{ secrets.AZURE_REDIS_CACHE_SECRET_NAME }}" \
                AZURE_OPENAI_SECRET_NAME="${{ secrets.AZURE_OPENAI_SECRET_NAME }}" \
                AZURE_AI_SEARCH_SECRET_NAME="${{ secrets.AZURE_AI_SEARCH_SECRET_NAME }}" \
                AZURE_AI_SEARCH_URL="${{ secrets.AZURE_AI_SEARCH_URL }}" \
                AZURE_AI_SEARCH_INDEX_NAME="${{ secrets.AZURE_AI_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                REDIS_TTL_SECONDS="${{ secrets.REDIS_TTL_SECONDS }}" \
                MAX_HISTORY_TURNS="${{ secrets.MAX_HISTORY_TURNS }}" \
                AZURE_ENTRAID_CLIENT_ID="${{ secrets.AZURE_ENTRAID_CLIENT_ID }}" \
                AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
                AZURE_CLIENT_SECRET_NAME="${{ secrets.AZURE_CLIENT_SECRET_NAME }}"
          fi


  # -----------------------------
  # Deploy Function App
  # -----------------------------
  deploy-function-app:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip python3 python3-pip curl
          pip3 install --upgrade pip azure-cli

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy Function App
        run: |
          set -e

          FUNCTION_APP="${{ secrets.AZURE_FUNCTION_APP }}"
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          STORAGE_ACCOUNT="${{ secrets.AZURE_STORAGE_ACCOUNT }}"
          CONTAINER_NAME="${{ secrets.AZURE_FUNCTION_APP_STORAGE_CONTAINER }}"
          ZIP_FILE="functionapp.zip"
          SAS_EXPIRY_MINUTES=10

          # Safety checks
          if [ -z "$CONTAINER_NAME" ]; then
            echo "❌ AZURE_FUNCTION_APP_STORAGE_CONTAINER secret is missing."
            exit 1
          fi
          if [ -z "$STORAGE_ACCOUNT" ]; then
            echo "❌ AZURE_STORAGE_ACCOUNT secret is missing."
            exit 1
          fi
          if [ -z "$FUNCTION_APP" ]; then
            echo "❌ AZURE_FUNCTION_APP secret is missing."
            exit 1
          fi

          # 1. Zip the function app
          if [ -d "./src/function-app" ]; then
            echo "[1/5] Creating ZIP..."
            zip -r "$ZIP_FILE" ./src/function-app > /dev/null
          else
            echo "❌ Function App folder './src/function-app' not found."
            exit 1
          fi

          # 2. Ensure storage container exists
          echo "[2/5] Ensuring storage container exists..."
          az storage container create \
            --account-name "$STORAGE_ACCOUNT" \
            --name "$CONTAINER_NAME" \
            --auth-mode login \
            --output none

          # 3. Upload ZIP to blob storage
          echo "[3/5] Uploading ZIP to blob storage..."
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name "$CONTAINER_NAME" \
            --name "$ZIP_FILE" \
            --file "$ZIP_FILE" \
            --overwrite \
            --auth-mode login

          # 4. Generate SAS token (user delegation SAS)
          echo "[4/5] Generating SAS token..."
          BLOB_EXPIRY=$(python3 -c "from datetime import datetime, timedelta, timezone; print((datetime.now(timezone.utc) + timedelta(minutes=$SAS_EXPIRY_MINUTES)).strftime('%Y-%m-%dT%H:%MZ'))")
          BLOB_SAS=$(az storage blob generate-sas \
            --account-name "$STORAGE_ACCOUNT" \
            --container-name "$CONTAINER_NAME" \
            --name "$ZIP_FILE" \
            --permissions r \
            --expiry "$BLOB_EXPIRY" \
            --https-only \
            --auth-mode login \
            --as-user \
            -o tsv)

          # 5. Update Function App to run from package
          echo "[5/5] Configuring Function App to run from ZIP..."
          BLOB_URL="https://$STORAGE_ACCOUNT.blob.core.windows.net/$CONTAINER_NAME/$ZIP_FILE?$BLOB_SAS"
          az functionapp config appsettings set \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --settings "WEBSITE_RUN_FROM_PACKAGE=$BLOB_URL"

          # ✅ Verify deployment
          echo "✅ Deployment complete. Verifying..."
          az functionapp config appsettings list \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "[?name=='WEBSITE_RUN_FROM_PACKAGE']"

  # --------------------------------------
  # Build & Push Frontend Container Image
  # --------------------------------------
  frontend-build-and-push:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[skip ci]') == false
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-dev gcc musl-dev libffi-dev make curl
          pip3 install --upgrade pip azure-cli docker

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME_FRONTEND:${GITHUB_REF_NAME}-${GITHUB_SHA::7}"
          docker build --no-cache -f "$DOCKERFILE_PATH_FRONTEND" -t "$IMAGE_TAG" .
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Docker login to ACR
        run: |
          echo "${{ secrets.AZURE_CLIENT_SECRET }}" | docker login "${{ secrets.AZURE_ACR_LOGIN_SERVER }}" \
            -u "${{ secrets.AZURE_CLIENT_ID }}" --password-stdin

      - name: Push Docker image
        run: |
          docker push "$IMAGE_TAG"
          docker tag "$IMAGE_TAG" "${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME_FRONTEND:dev-latest"
          docker push "${{ secrets.AZURE_ACR_LOGIN_SERVER }}/$IMAGE_NAME_FRONTEND:dev-latest"

      - name: Save IMAGE_TAG for deploy jobs
        run: echo "$IMAGE_TAG" > image_tag.txt

      - uses: actions/upload-artifact@v4
        with:
          name: image_tag_frontend
          path: image_tag.txt

  # ------------------------------
  # Deploy Frontend Container App
  # ------------------------------
  deploy-frontend-container-app:
    runs-on: ubuntu-latest
    needs: frontend-build-and-push
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: image_tag_frontend

      - name: Load IMAGE_TAG
        run: echo "IMAGE_TAG=$(cat image_tag.txt)" >> $GITHUB_ENV

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip curl
          pip3 install --upgrade pip azure-cli

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.AZURE_CLIENT_ID }}" \
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" \
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Deploy Container App
        run: |
          set -e
          CONTAINER_APP="${{ secrets.AZURE_CONTAINER_APP_FRONTEND }}"
          RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
          CONTAINERAPPS_ENV="${{ secrets.AZURE_CONTAINERAPPS_ENV }}"
          IMAGE="$IMAGE_TAG"

          APP_EXISTS=$(az containerapp show \
            --name "$CONTAINER_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "name" -o tsv || echo "")

          if [ -n "$APP_EXISTS" ]; then
            echo "Updating existing Container App with new image..."
            az containerapp update \
              --name "$CONTAINER_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --image "$IMAGE" \
              --set-env-vars \
                KEY_VAULT_URL="${{ secrets.KEY_VAULT_URL }}" \
                AZURE_REDIS_CACHE_SECRET_NAME="${{ secrets.AZURE_REDIS_CACHE_SECRET_NAME }}" \
                AZURE_OPENAI_SECRET_NAME="${{ secrets.AZURE_OPENAI_SECRET_NAME }}" \
                AZURE_AI_SEARCH_SECRET_NAME="${{ secrets.AZURE_AI_SEARCH_SECRET_NAME }}" \
                AZURE_AI_SEARCH_URL="${{ secrets.AZURE_AI_SEARCH_URL }}" \
                AZURE_AI_SEARCH_INDEX_NAME="${{ secrets.AZURE_AI_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                REDIS_TTL_SECONDS="${{ secrets.REDIS_TTL_SECONDS }}" \
                MAX_HISTORY_TURNS="${{ secrets.MAX_HISTORY_TURNS }}" \
                AZURE_ENTRAID_CLIENT_ID="${{ secrets.AZURE_ENTRAID_CLIENT_ID }}" \
                AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
                AZURE_CLIENT_SECRET_NAME="${{ secrets.AZURE_CLIENT_SECRET_NAME }}"

          else
            echo "Container App does not exist, creating..."
            az containerapp create \
              --name "$CONTAINER_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINERAPPS_ENV" \
              --image "$IMAGE" \
              --ingress external \
              --target-port 80 \
              --cpu 2.0 \
              --memory 2.0Gi \
              --revision-mode Single \
              --set-env-vars \
                KEY_VAULT_URL="${{ secrets.KEY_VAULT_URL }}" \
                AZURE_REDIS_CACHE_SECRET_NAME="${{ secrets.AZURE_REDIS_CACHE_SECRET_NAME }}" \
                AZURE_OPENAI_SECRET_NAME="${{ secrets.AZURE_OPENAI_SECRET_NAME }}" \
                AZURE_AI_SEARCH_SECRET_NAME="${{ secrets.AZURE_AI_SEARCH_SECRET_NAME }}" \
                AZURE_AI_SEARCH_URL="${{ secrets.AZURE_AI_SEARCH_URL }}" \
                AZURE_AI_SEARCH_INDEX_NAME="${{ secrets.AZURE_AI_SEARCH_INDEX_NAME }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
                AZURE_OPENAI_API_VERSION="${{ secrets.AZURE_OPENAI_API_VERSION }}" \
                REDIS_TTL_SECONDS="${{ secrets.REDIS_TTL_SECONDS }}" \
                MAX_HISTORY_TURNS="${{ secrets.MAX_HISTORY_TURNS }}" \
                AZURE_ENTRAID_CLIENT_ID="${{ secrets.AZURE_ENTRAID_CLIENT_ID }}" \
                AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
                AZURE_CLIENT_SECRET_NAME="${{ secrets.AZURE_CLIENT_SECRET_NAME }}"
          fi